<!DOCTYPE html>
<html lang="en">
<link rel="icon" type="image/png"
    href="https://raw.githubusercontent.com/Aceship/Arknight-Images/main/avatars/char_150_snakek.png">

<head>
    <title>ArkPRTS</title>
    <meta charset="UTF-8">
    <meta name="description" content="Search arknights users updated real-time.">
    <meta name="keywords" content="arknights search real-time">
    <meta property="og:site_name" content="Search arknights users updated real-time.">


    {% if users %}
    {% set user = users[0] %}
    <meta property="og:title" content="{{ user.nickname }}#{{ user.nick_number }} - {{ user.uid }}" />
    <meta property="og:image" content="{{ get_avatar(user.secretary, user.secretary_skin_id) }}" />
    {# I apologize for this mess, no idea how else to eliminate whitespace #}
    <meta property="og:description" content="
{{ user.resume }}

Level: {{ user.level }}
Playing since: {{ user.register_ts.strftime('%Y-%m-%d') }}
Last online: {{ user.last_online_time.astimezone(datetime.timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC') }}
Characters: {{ user.char_cnt}}

Support units:
{% for support in user.assist_char_list|reject('none')|rejectattr('skill_index', 'eq', -1) 
%}{% set skill = support.skills[support.skill_index] 
%}{{support.static.name}} - E{{ support.evolve_phase }}L{{ support.level 
}}{% if support.potential_rank %} P{{ support.potential_rank + 1}}{% endif 
%} S{{ support.skill_index+1 }}M{{ skill.specialize_level }}{% if support.skills|sum(attribute='specialize_level') > skill.specialize_level
%} (M{{ support.skills|sum(attribute='specialize_level') }}){% endif 
%}{% if support.current_equip and '001' not in support.current_equip 
%}{% set module = gamedata.uniequip_table.equip_dict[support.current_equip] 
%} | {{ module.type_name_1 }}-{{ module.type_name_2 }} L{{ support.equip[support.current_equip].level }}{% endif %}
{%endfor%}
    " />
    {% endif %}
</head>

<link rel="stylesheet" href="static/style.css">

<style>
    img {
        height: 12px
    }
</style>

<link rel="stylesheet" href="static/style.css">

<body>
    <div id="search">
        <form action="/search" method="GET">
            {# the defaults should be based on the query parameters #}
            {% set nickname = request.query.get("nickname", "") %}
            {% set server = request.query.get("server", "en") %}
            {% set all = request.query.get("all", "0") == "1" %}
            <input type="text" name="nickname" placeholder="Search for player" value="{{ nickname }}" required>
            <select name="server">
                <option value="en" {{"selected" if server=="en" }}>EN</option>
                <option value="jp" {{"selected" if server=="jp" }}>JP</option>
                <option value="kr" {{"selected" if server=="kr" }}>KR</option>
            </select>
            <input type="checkbox" name="all" value="1" {{ 'checked' if all else '' }}>
            <label for="all" style="font-size: 12px">Show all</label>
            &nbsp;&nbsp;&nbsp;&nbsp;
            <input type="submit" value="Search">
        </form>
    </div>
    <div id="login">
        <form method="GET" action="/user">
            <input type="submit" value="Login">
        </form>
    </div>

    <br>
    <div class="simple-border">
        {% if not users %}
        Please enter a nickname to search for (case-sensitive).
        {% endif %}
        {% for user in users %}
        <div id="{{ user.uid }}">
            {# TODO: Support default and event avatars #}
            <span class="hoverable">
                {% set sec = gamedata.get_operator(user.secretary or 'char_002_amiya') %}
                <a class="thumb" href="https://arknights.wiki.gg/wiki/{{ sec.name.replace(' ', '_') }}">
                    <img src="{{ get_avatar(user.secretary, user.secretary_skin_id) }}" class="avatar-img"
                        title="{{ sec.name }}">
                    <span>
                        <img src="{{ get_image('characters', user.secretary_skin_id) }}">
                    </span>
                </a>
            </span>
            <div>
                <div class="title">
                    LV{{ user.level }}
                    <b>{{ user.nickname }}#{{ user.nick_number }}</b> -
                    {{ user.uid }} {# ({{user.server_name }}) #}
                </div>
                <i>{{ user.resume }}</i>
            </div>
            <div class="clear-both">
                Playing since: {{ user.register_ts.strftime("%Y-%m-%d") }}<br>
                Last online: {{ user.last_online_time.astimezone(datetime.timezone.utc).strftime("%Y-%m-%d %H:%M:%S
                UTC") }}<br>
                {% if user.main_stage_progress %}
                {% set stage = gamedata.stage_table.stages[user.main_stage_progress] %}
                Current stage: {{ stage.code }} ({{ stage.name }})<br>
                {% else %}
                Current stage: Completed<br>
                {% endif %}
                Characters: {{ user.char_cnt}}
                Furniture: {{ user.furn_cnt }}
            </div>
            <br>
            <div>
                <div>
                    Support units:
                    <!-- skipping all 1*/2* skill-less operators cause I don't wanna deal with that -->
                    {% for support in user.assist_char_list|reject("none")|rejectattr("skill_index", "eq", -1) %}
                    <div class="clear-both">
                        <span class="hoverable">
                            <a class="thumb"
                                href="https://arknights.wiki.gg/wiki/{{ support.static.name.replace(' ', '_') }}">
                                <img src="{{ get_avatar(support.char_id, support.skin_id) }}" class="operator-img"
                                    title="{{ support.static.name }}">
                                <span>
                                    <img src="{{ get_image('characters', support.skin_id) }}">
                                </span>
                            </a>
                        </span>

                        {% if support.potential_rank %}
                        <img src="{{ get_image('ui/potential', support.potential_rank + 1) }}"
                            title="Potential {{ support.potential_rank + 1 }}">
                        {% endif %}

                        <b>{{ support.static.name }}</b>

                        <img src="{{ get_image('ui/elite', support.evolve_phase) }}"
                            title="Elite {{ support.evolve_phase }}">
                        E{{ support.evolve_phase }}L{{ support.level }}

                        {% set skill = support.skills[support.skill_index] %}
                        <img src="{{ get_image('skills', 'skill_icon_' + (skill.static.icon_id or skill.skill_id)) }}"
                            title="{{ skill.static.levels[support.main_skill_lvl-1+skill.specialize_level].name }}">
                        S{{ support.skill_index+1 }}M{{ skill.specialize_level }}

                        <br>

                        trust {{ support.trust }}% ({{ support.favor_point }})

                        skills LV{{ support.main_skill_lvl }}
                        {% for skill in support.skills %}
                        <span class="relative">
                            <img src="{{ get_image('skills', 'skill_icon_' + (skill.static.icon_id or skill.skill_id)) }}"
                                title="{{ skill.static.levels[support.main_skill_lvl-1+skill.specialize_level].name }}">
                            {% if skill.specialize_level > 0 %}
                            <img src="{{ get_image('ui/rank', 'm-'+(skill.specialize_level|string)) }}"
                                class="mastery-img"
                                title="{{ skill.static.levels[support.main_skill_lvl-1+skill.specialize_level].name }} M{{ skill.specialize_level }}">
                            {% endif %}
                            {# {{skill.static.levels[support.main_skill_lvl-1].name}} #}
                        </span>
                        {% endfor %}

                        {% if support.current_equip and "001" not in support.current_equip %}
                        {% set module = gamedata.uniequip_table["equipDict"][support.current_equip] %}
                        {% set module_name = module.type_name_1 + "-" + module.type_name_2 %}
                        &nbsp;&nbsp;&nbsp;&nbsp;
                        <img src="{{ get_image('equip/type', module_name.lower()) }}" style="filter:invert(1)">
                        {{ module_name }} L{{ support.equip[support.current_equip].level }}
                        {% endif %}

                        <br>
                    </div>
                    {% endfor %}
                </div>
                <br>
                <div>
                    Teams:
                    <div style="display: grid; grid-template-columns: repeat(12, 1fr); width: fit-content">
                        {% for team, amount in user.team_v2.items() %}
                        <span>
                            <img src="{{ get_image('factions', 'logo_' + team) }}" style="filter:invert(1)"
                                title="{{ gamedata.handbook_team_table[team].power_name }}">
                            <b>{{amount}}</b>
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <hr>
        </div>
        {% endfor %}
    </div>
</body>

<footer>
    Made with ArkPRTS
</footer>

</html>
